name: iOS Local Build (GH Actions) + Submit (EAS)

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ios-local-build:
    runs-on: macos-latest
    timeout-minutes: 75

    env:
      # âœ… Modern EAS auth in CI: use an access token via env var.
      # Keep both names for compatibility with different eas-cli behaviors.
      EAS_ACCESS_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ðŸ”’ Safety: explicitly blank this so a repository/org-level env var can't hijack the build.
      # (Your error came from an EAS_PROJECT_ID that points to a different slug/project.)
      EAS_PROJECT_ID: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: Install system dependencies (CocoaPods + cocoapods-spm)
        run: |
          brew install cocoapods
          gem install cocoapods-spm --no-document

      - name: Install JS dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Verify EAS auth
        run: eas whoami

      - name: Validate EAS project ID matches slug
        run: |
          node - <<'NODE'
          const { execSync } = require('child_process');

          const app = require('./app.json');
          const slug = app?.expo?.slug;
          const projectId = app?.expo?.extra?.eas?.projectId;

          if (!slug || !projectId) {
            process.exit(0);
          }

          let info;
          try {
            info = JSON.parse(
              execSync('eas project:info --json', {
                stdio: ['ignore', 'pipe', 'pipe'],
                env: {
                  ...process.env,
                  EAS_PROJECT_ID: projectId,
                },
              })
                .toString()
                .trim(),
            );
          } catch (error) {
            console.warn(
              'Unable to fetch EAS project info; skipping slug validation.',
            );
            process.exit(0);
          }

          const infoSlug = info?.slug ?? info?.project?.slug ?? info?.name;
          if (infoSlug && infoSlug !== slug) {
            throw new Error(
              `EAS project slug "${infoSlug}" does not match app.json slug "${slug}".`,
            );
          }
          NODE

      - name: Build iOS (local)
        run: |
          mkdir -p artifacts/ios
          eas build --platform ios --local --profile production --non-interactive --output artifacts/ios/build.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: artifacts/ios/build.ipa
          if-no-files-found: error

      - name: Submit to App Store Connect (push to main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          eas submit --platform ios --profile production --path artifacts/ios/build.ipa --non-interactive
