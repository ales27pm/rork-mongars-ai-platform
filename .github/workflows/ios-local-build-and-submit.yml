name: iOS Local Build (GH Actions) + Submit (EAS)

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ios-local-build:
    runs-on: macos-latest
    timeout-minutes: 75

    env:
      # âœ… Modern EAS auth in CI: use an access token via env var.
      # Keep both names for compatibility with different eas-cli behaviors.
      EAS_ACCESS_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ðŸ”’ Safety: explicitly blank this so a repository/org-level env var can't hijack the build.
      # (Your error came from an EAS_PROJECT_ID that points to a different slug/project.)
      EAS_PROJECT_ID: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: Install system dependencies (CocoaPods + cocoapods-spm)
        run: |
          brew install cocoapods
          gem install cocoapods-spm --no-document

      - name: Install JS dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Verify EAS auth
        run: eas whoami

      - name: Validate EAS project ID matches slug
        run: |
          node - <<'NODE'
          const { execSync } = require('child_process');

          const app = require('./app.json');
          const slug = app?.expo?.slug;
          const projectId = app?.expo?.extra?.eas?.projectId;

          if (!slug || !projectId) {
            process.exit(0);
          }

          let info;
          try {
            info = JSON.parse(
              execSync('eas project:info --json', {
                stdio: ['ignore', 'pipe', 'pipe'],
                env: {
                  ...process.env,
                  EAS_PROJECT_ID: projectId,
                },
              })
                .toString()
                .trim(),
            );
          } catch (error) {
            console.warn(
              'Unable to fetch EAS project info; skipping slug validation.',
            );
            process.exit(0);
          }

          const infoSlug = info?.slug ?? info?.project?.slug ?? info?.name;
          if (infoSlug && infoSlug !== slug) {
            throw new Error(
              `EAS project slug "${infoSlug}" does not match app.json slug "${slug}".`,
            );
          }
          NODE

      - name: Validate iOS credentials are configured in EAS
        run: |
          node - <<'NODE'
          const { execSync } = require('child_process');

          let output;
          try {
            output = execSync(
              'eas credentials --platform ios --profile production --non-interactive --json',
              {
                stdio: ['ignore', 'pipe', 'pipe'],
              },
            )
              .toString()
              .trim();
          } catch (error) {
            console.error(
              'EAS iOS credentials are not validated for non-interactive builds. Run `eas credentials --platform ios` locally to set them up.',
            );
            process.exit(1);
          }

          const payload = output ? JSON.parse(output) : null;
          const hasDistribution = Boolean(
            payload?.distributionCertificate?.serialNumber ??
              payload?.distributionCertificate?.id,
          );
          const hasProvisioningProfile = Boolean(
            payload?.provisioningProfile?.id ??
              payload?.provisioningProfile?.status,
          );

          if (!hasDistribution || !hasProvisioningProfile) {
            console.error(
              'EAS iOS credentials are missing or incomplete. Run `eas credentials --platform ios` locally to configure them.',
            );
            process.exit(1);
          }
          NODE

      - name: Build iOS (remote)
        run: |
          eas build \
            --platform ios \
            --profile production \
            --non-interactive \
            --wait \
            --message "CI signed build"

      - name: Download IPA artifact
        run: |
          mkdir -p artifacts/ios
          BUILD_LIST_JSON=$(eas build:list --platform ios --limit 1 --json --non-interactive --no-color 2>&1 | python - <<'PY'
          import sys

          data = sys.stdin.read()
          start = data.find("[")
          end = data.rfind("]")
          if start == -1 or end == -1 or end < start:
              sys.exit(1)
          sys.stdout.write(data[start : end + 1])
          PY
          )
          BUILD_ID=$(echo "$BUILD_LIST_JSON" | jq -r '.[0].id')
          if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
            echo "âŒ Unable to determine latest iOS build ID"
            exit 1
          fi
          BUILD_VIEW_JSON=$(eas build:view "$BUILD_ID" --json --non-interactive --no-color 2>&1 | python - <<'PY'
          import sys

          data = sys.stdin.read()
          start = data.find("{")
          end = data.rfind("}")
          if start == -1 or end == -1 or end < start:
              sys.exit(1)
          sys.stdout.write(data[start : end + 1])
          PY
          )
          ARTIFACT_URL=$(echo "$BUILD_VIEW_JSON" | jq -r '.artifacts.buildUrl')
          if [ -z "$ARTIFACT_URL" ] || [ "$ARTIFACT_URL" = "null" ]; then
            echo "âŒ Unable to resolve artifact URL for build $BUILD_ID"
            exit 1
          fi
          curl -L "$ARTIFACT_URL" -o artifacts/ios/build.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: artifacts/ios/build.ipa
          if-no-files-found: error

      - name: Submit to App Store Connect (push to main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          eas submit --platform ios --profile production --path artifacts/ios/build.ipa --non-interactive
