name: iOS Build (CocoaPods + SPM)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  ios-build:
    runs-on: macos-latest
    env:
      BUNDLE_FORCE_RUBY_PLATFORM: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby & gems
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Print Ruby, Bundler & gem info
        run: |
          which ruby
          ruby -v
          gem env
          bundler -v

      - name: Remove previous gems and project artifacts
        run: |
          gem uninstall -aIx || true
          rm -rf vendor/bundle
          rm -rf ios/Pods ios/Podfile.lock ios/build ios/monGARS.xcworkspace
          rm -rf $HOME/Library/Developer/Xcode/DerivedData

      - name: Install Homebrew dependencies
        run: |
          brew install cocoapods
          brew install node

      - name: Install bun (if needed)
        run: npm install -g bun

      - name: Install JS dependencies
        run: yarn install --frozen-lockfile || npm install

      - name: Bundle install (Ruby gems)
        env:
          BUNDLE_FORCE_RUBY_PLATFORM: true
        run: |
          rm -rf vendor/bundle
          bundle install --jobs 4 --force

      - name: Patch cocoapods-spm if needed
        run: |
          set -euo pipefail

          # Some CI environments don't expose the bundled cocoapods-spm version constant
          # where the plugin expects it.
          bundle exec ruby -e "require 'fileutils'; spec = Gem::Specification.find_by_name('cocoapods-spm'); gem_dir = spec.gem_dir; gem_version_path = File.join(gem_dir, 'lib', 'cocoapods-spm', 'gem_version.rb'); unless File.exist?(gem_version_path); FileUtils.mkdir_p(File.dirname(gem_version_path)); File.write(gem_version_path, \"module CocoapodsSpm\n  GEM_VERSION = '#{spec.version}'\nend\n\"); puts \"patched cocoapods-spm gem_version.rb at #{gem_version_path}\"; end"

          # cocoapods-spm 0.1.20 assumes CocoaPods always generates the per-config
          # xcfilelist files for the embed frameworks / copy resources scripts.
          # When a project has *no* resources for a given target/config, CocoaPods
          # may legitimately skip generating the resources xcfilelists, causing an
          # ENOENT in cocoapods-spm's post_integrate hooks.
          #
          # Patch the plugin to create missing xcfilelists on the fly.
          python3 - <<'PY'
          import pathlib
          import subprocess

          gem_dir = subprocess.check_output(
              [
                  "bundle",
                  "exec",
                  "ruby",
                  "-e",
                  "require 'rubygems'; print Gem::Specification.find_by_name('cocoapods-spm').gem_dir",
              ]
          ).decode("utf-8")

          p = pathlib.Path(gem_dir) / "lib" / "cocoapods-spm" / "hooks" / "helpers" / "update_script.rb"
          src = p.read_text(encoding="utf-8")

          needle = 'target.send(method_name, config).open("r+") do |f|'
          if needle not in src:
              raise SystemExit(f"Expected pattern not found in {p}")

          if "file_path = target.send(method_name, config)" in src:
              print(f"cocoapods-spm already patched: {p}")
              raise SystemExit(0)

          patched = src.replace(
              needle,
              "file_path = target.send(method_name, config)\n"
              "            FileUtils.mkdir_p(file_path.dirname) unless file_path.dirname.exist?\n"
              "            file_path.write(\"\") unless file_path.exist?\n"
              "            file_path.open(\"r+\") do |f|",
          )

          # Ensure FileUtils is available.
          if "require 'fileutils'" not in patched:
              patched = "require 'fileutils'\n" + patched

          p.write_text(patched, encoding="utf-8")
          print(f"Patched cocoapods-spm update_script.rb: {p}")
          PY

      - name: Install CocoaPods dependencies
        run: |
          bundle exec pod install --project-directory=ios

      - name: Build iOS app
        run: |
          cd ios
          xcodebuild -workspace monGARS.xcworkspace -scheme monGARS -configuration Release -sdk iphoneos

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: ios/build/Release-iphoneos/
