name: iOS Build (CocoaPods + SPM)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  ios-build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Homebrew dependencies
        run: |
          brew install cocoapods
          brew install node

      - name: Install bun (if needed)
        run: |
          npm install -g bun

      - name: Clean previous gems and set Ruby platform
        run: |
          rm -rf vendor/bundle
          export BUNDLE_FORCE_RUBY_PLATFORM=true
          bundle install --force --jobs 4

      - name: Patch cocoapods-spm if needed
        run: |
          bundle exec ruby -e "
            require 'fileutils'
            spec = Gem::Specification.find_by_name('cocoapods-spm')
            gem_dir = spec.gem_dir
            gem_version_path = File.join(gem_dir, 'lib', 'cocoapods-spm', 'gem_version.rb')
            unless File.exist?(gem_version_path)
              FileUtils.mkdir_p(File.dirname(gem_version_path))
              File.write(gem_version_path, \"module CocoapodsSpm\\n  GEM_VERSION = '#{spec.version}'\\nend\\n\")
              puts \"patched cocoapods-spm gem_version.rb at #{gem_version_path}\"
            end
          "

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          bundle exec pod install

      # Add your build steps here, e.g. Xcode build, archive, export, etc.
      # Example:
      # - name: Build iOS app
      #   run: |
      #     cd ios
      #     xcodebuild -workspace monGARS.xcworkspace -scheme monGARS -configuration Release -sdk iphoneos

      # You can also upload artifacts, e.g. .ipa files, using actions/upload-artifact
