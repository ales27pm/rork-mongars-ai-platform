name: iOS Build + Sign + Submit (EAS)

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ios-eas-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ios-eas:
    # EAS Build runs on Expo's workers, so this job does not need macOS.
    runs-on: ubuntu-latest

    env:
      CI: "1"
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      ASC_API_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # Do NOT enable dependency caching here unless a lockfile exists.
          # This repo does not currently include yarn.lock/package-lock.json/pnpm-lock.yaml.

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f yarn.lock ]; then
            echo "Using Yarn with lockfile"
            yarn --version
            yarn install --frozen-lockfile --non-interactive
          elif [ -f package-lock.json ]; then
            echo "Using npm ci"
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            echo "Using pnpm with lockfile"
            corepack prepare pnpm@latest --activate
            pnpm --version
            pnpm install --frozen-lockfile
          else
            echo "No lockfile found; installing with Yarn (no frozen lockfile)"
            yarn --version || npm i -g yarn
            yarn install --non-interactive
          fi

      - name: Install EAS CLI
        run: |
          npm i -g eas-cli
          eas --version

      - name: Prepare App Store Connect API key file
        shell: bash
        run: |
          set -euo pipefail

          # The submit profile in eas.json expects:
          #   credentials/ios/AuthKey_8H354F29PN.p8
          mkdir -p credentials/ios

          if [ -z "${ASC_API_KEY_P8:-}" ]; then
            echo "ASC_API_KEY_P8 secret is missing. Add it (base64 of the .p8, or the raw .p8 contents)." >&2
            exit 1
          fi

          # If the secret looks like a raw .p8, write it directly.
          if echo "$ASC_API_KEY_P8" | grep -q "BEGIN PRIVATE KEY"; then
            printf "%s\n" "$ASC_API_KEY_P8" > credentials/ios/AuthKey_8H354F29PN.p8
          else
            # Otherwise assume it's base64.
            echo "$ASC_API_KEY_P8" | base64 -d > credentials/ios/AuthKey_8H354F29PN.p8
          fi

          chmod 600 credentials/ios/AuthKey_8H354F29PN.p8
          echo "Wrote credentials/ios/AuthKey_8H354F29PN.p8"

      - name: EAS Build (iOS, production)
        run: |
          set -euo pipefail
          eas build --platform ios --profile production --non-interactive --wait

      - name: EAS Submit (iOS, production)
        run: |
          set -euo pipefail
          eas submit --platform ios --profile production --non-interactive --latest

      - name: Show latest build info
        if: always()
        run: |
          eas build:list --platform ios --limit 5 --non-interactive || true
