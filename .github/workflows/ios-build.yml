name: iOS Build + Sign + Submit (EAS)

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ios-eas-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ios-eas:
    runs-on: macos-latest

    env:
      CI: "1"
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: Install system dependencies (CocoaPods + cocoapods-spm)
        run: |
          brew install cocoapods
          gem install cocoapods-spm --no-document

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f bun.lockb ] || [ -f bun.lock ]; then
            echo "Using Bun"
            bun --version
            bun install --no-progress
          elif [ -f yarn.lock ]; then
            echo "Using Yarn with lockfile"
            corepack enable
            yarn --version
            yarn install --frozen-lockfile --non-interactive
          elif [ -f package-lock.json ]; then
            echo "Using npm ci"
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            echo "Using pnpm with lockfile"
            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm --version
            pnpm install --frozen-lockfile
          else
            echo "No lockfile found; falling back to npm install"
            npm install
          fi

      - name: Lint
        run: npm run lint

      - name: Tests
        run: npm test -- --passWithNoTests

      - name: Format check
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t format_files < <(
            git ls-files \
              '*.js' \
              '*.ts' \
              '*.tsx' \
              '*.json' \
              '*.yml' \
              '*.yaml' \
              '*.md' \
              '*.cjs' \
              '*.mjs' \
              '*.sh'
          )
          if [ "${#format_files[@]}" -eq 0 ]; then
            echo "No files to format-check."
            exit 0
          fi
          npx prettier --check "${format_files[@]}"

      - name: Install EAS CLI
        run: |
          npm i -g eas-cli
          eas --version

      - name: Build iOS (local)
        run: |
          set -euo pipefail
          mkdir -p artifacts/ios
          eas build --platform ios --local --profile production --non-interactive --output artifacts/ios/build.ipa --clear-cache

      - name: EAS Submit (iOS, production)
        run: |
          set -euo pipefail
          eas submit --platform ios --profile production --path artifacts/ios/build.ipa --non-interactive

      - name: Show latest build info
        if: always()
        run: |
          eas build:list --platform ios --limit 5 --non-interactive || true
