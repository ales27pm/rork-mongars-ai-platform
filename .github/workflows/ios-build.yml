name: iOS Build + Sign + Submit (EAS)

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ios-eas-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ios-eas:
    # EAS Build runs on Expo's workers, so this job does not need macOS.
    runs-on: ubuntu-latest

    env:
      CI: "1"
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f bun.lockb ] || [ -f bun.lock ]; then
            echo "Using Bun"
            bun --version
            bun install --no-progress
          elif [ -f yarn.lock ]; then
            echo "Using Yarn with lockfile"
            corepack enable
            yarn --version
            yarn install --frozen-lockfile --non-interactive
          elif [ -f package-lock.json ]; then
            echo "Using npm ci"
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            echo "Using pnpm with lockfile"
            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm --version
            pnpm install --frozen-lockfile
          else
            echo "No lockfile found; falling back to npm install"
            npm install
          fi

      - name: Install EAS CLI
        run: |
          npm i -g eas-cli
          eas --version

      - name: EAS Build (iOS, production)
        run: |
          set -euo pipefail
          eas build --platform ios --profile production --non-interactive --wait

      - name: EAS Submit (iOS, production)
        run: |
          set -euo pipefail
          eas submit --platform ios --profile production --non-interactive --latest

      - name: Show latest build info
        if: always()
        run: |
          eas build:list --platform ios --limit 5 --non-interactive || true
