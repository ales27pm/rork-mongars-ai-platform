name: iOS Build + Sign + Submit (EAS)

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ios-eas-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ios-eas:
    # EAS Build runs on Expo's workers, so this job does not need macOS.
    runs-on: ubuntu-latest

    env:
      CI: '1'
      # Required: create this GitHub Actions secret in your repo settings.
      # It must be an Expo/EAS access token (Expo account settings -> Access Tokens).
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # Optional but recommended: store your ASC API key contents in base64 form.
      # If you store the raw .p8 (multiline) instead, the workflow will handle that too.
      ASC_API_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install JS dependencies
        run: |
          corepack enable
          yarn --version
          yarn install --frozen-lockfile

      - name: Install EAS CLI
        run: |
          npm i -g eas-cli
          eas --version

      - name: Prepare App Store Connect API key file
        shell: bash
        run: |
          set -euo pipefail

          # The submit profile in eas.json expects:
          #   credentials/ios/AuthKey_8H354F29PN.p8
          mkdir -p credentials/ios

          if [ -z "${ASC_API_KEY_P8:-}" ]; then
            echo "ASC_API_KEY_P8 secret is missing. Add it (base64 of the .p8, or the raw .p8 contents)." >&2
            exit 1
          fi

          # If the secret looks like a raw .p8, write it directly.
          if echo "$ASC_API_KEY_P8" | grep -q "BEGIN PRIVATE KEY"; then
            printf "%s\n" "$ASC_API_KEY_P8" > credentials/ios/AuthKey_8H354F29PN.p8
          else
            # Otherwise assume it's base64.
            echo "$ASC_API_KEY_P8" | base64 -d > credentials/ios/AuthKey_8H354F29PN.p8
          fi

          chmod 600 credentials/ios/AuthKey_8H354F29PN.p8

          echo "Wrote credentials/ios/AuthKey_8H354F29PN.p8"

      - name: EAS Build (iOS, production)
        run: |
          set -euo pipefail
          # Build on EAS workers (signing handled via credentialsSource=remote).
          eas build --platform ios --profile production --non-interactive --wait

      - name: EAS Submit (iOS, production)
        run: |
          set -euo pipefail
          # Submits the most recent iOS build using the submit profile in eas.json.
          eas submit --platform ios --profile production --non-interactive --latest

      - name: Show latest build info
        if: always()
        run: |
          eas build:list --platform ios --limit 5 --non-interactive || true
