name: iOS Local Build (GH Actions) + Submit (EAS)

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ios-local-build:
    runs-on: macos-latest
    timeout-minutes: 75

    env:
      # âœ… Modern EAS auth in CI: use an access token via env var.
      # Keep both names for compatibility with different eas-cli behaviors.
      EAS_ACCESS_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ðŸ”’ Safety: explicitly blank this so a repository/org-level env var can't hijack the build.
      # (Your error came from an EAS_PROJECT_ID that points to a different slug/project.)
      EAS_PROJECT_ID: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: Install system dependencies (CocoaPods + cocoapods-spm)
        run: |
          brew install cocoapods
          gem install cocoapods-spm --no-document
          gem install fastlane --no-document

      - name: Prepare Ruby gems
        shell: bash
        run: |
          set -euo pipefail
          GEM_HOME="$HOME/.gems/$(uname -m)"
          echo "GEM_HOME=$GEM_HOME" >> "$GITHUB_ENV"
          echo "GEM_PATH=$GEM_HOME:${GEM_PATH:-}" >> "$GITHUB_ENV"
          echo "$GEM_HOME/bin" >> "$GITHUB_PATH"
          gem install bundler --no-document
          bundle config set path "$GEM_HOME" > /dev/null
          bundle install --jobs 4 --retry 3
          bundle exec ruby -e "
            require 'fileutils'
            spec = Gem::Specification.find_by_name('cocoapods-spm')
            gem_version_path = File.join(spec.gem_dir, 'lib', 'cocoapods-spm', 'gem_version.rb')
            unless File.exist?(gem_version_path)
              FileUtils.mkdir_p(File.dirname(gem_version_path))
              File.write(gem_version_path, \"module CocoapodsSpm\\n  GEM_VERSION = '#{spec.version}'\\nend\\n\")
            end
            require 'cocoapods'
            require 'cocoapods-spm'
            puts 'OK: cocoapods + cocoapods-spm'
          "

      - name: Install JS dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f bun.lockb ] || [ -f bun.lock ]; then
            echo "Using Bun"
            bun --version
            bun install --no-progress
          elif [ -f yarn.lock ]; then
            echo "Using Yarn with lockfile"
            corepack enable
            yarn --version
            yarn install --frozen-lockfile --non-interactive
          elif [ -f package-lock.json ]; then
            echo "Using npm ci"
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            echo "Using pnpm with lockfile"
            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm --version
            pnpm install --frozen-lockfile
          else
            echo "No lockfile found; falling back to npm install"
            npm install
          fi

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Verify EAS auth
        run: eas whoami

      - name: Link/create EAS project (non-interactive)
        run: |
          eas project:init --non-interactive --force
          eas project:info || true

      - name: Clear local credentials
        run: |
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/* 2>/dev/null || true
          echo "Cleared local provisioning profiles to force EAS remote fetch"

      - name: Build iOS (local)
        run: |
          mkdir -p artifacts/ios
          eas build --platform ios --local --profile production --non-interactive --output artifacts/ios/build.ipa --clear-cache

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: artifacts/ios/build.ipa
          if-no-files-found: error

      - name: Submit to App Store Connect (push to main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          eas submit --platform ios --profile production --path artifacts/ios/build.ipa --non-interactive
