name: ğŸš€ iOS Production Pipeline

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch to run this workflow on"
        required: true
        default: "main"

env:
  NODE_VERSION: "20"
  EXPO_VERSION: "latest"

jobs:
  quality-gate:
    name: ğŸ” Quality Gate
    if: github.ref_name == inputs.target_branch
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ” TypeScript check
        run: npx tsc --noEmit

      - name: ğŸ§¹ ESLint check
        run: npm run lint

      - name: âœ… Tests (if configured)
        run: |
          if grep -q "\"test\":" package.json; then
            npm test -- --coverage --passWithNoTests
          else
            echo "No test script configured, skipping tests"
          fi

      - name: ğŸ“Š Upload coverage (if available)
        uses: codecov/codecov-action@v3
        if: success()
        continue-on-error: true

  build-analysis:
    name: ğŸ“¦ Build Analysis
    if: github.ref_name == inputs.target_branch
    runs-on: ubuntu-latest
    needs: quality-gate

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ“Š Bundle size analysis
        run: |
          echo "ğŸ” Analyzing bundle size..."
          du -sh node_modules/ || echo "Could not analyze node_modules size"

      - name: ğŸ” Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [quality-gate, build-analysis]
    if: github.ref_name == inputs.target_branch

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: âœ… Deployment ready
        run: |
          echo "âœ… All checks passed"
          echo "ğŸ“¦ Ready for deployment"
          echo "ğŸ¯ Branch: ${{ github.ref }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"

      - name: ğŸ‰ Create Release Notes
        run: |
          echo "## Release Information" >> release-notes.md
          echo "- Branch: ${{ github.ref }}" >> release-notes.md
          echo "- Commit: ${{ github.sha }}" >> release-notes.md
          echo "- Build Time: $(date)" >> release-notes.md
          cat release-notes.md

      - name: ğŸ“¤ Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md

  notification:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && github.ref_name == inputs.target_branch

    steps:
      - name: ğŸ“¢ Workflow Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Pipeline completed successfully!"
          else
            echo "âŒ Pipeline failed or was cancelled"
          fi
